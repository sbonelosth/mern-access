# mern-access

A focused, plug‚Äëand‚Äëplay authentication package for **MERN** applications (MongoDB + Express + React + Node).  
Provides ready-to-use routes for signup (OTP), verify, login, refresh, logout (all), and a `protect` middleware for securing routes.  
It expects a Mongoose `User` model and lets you plug in any email sender or user data mapper.

---

## üöÄ Quick Start (TL;DR)

1. Install:  
   ```bash
   npm install mern-access
   ```

2. Connect Mongoose, provide a `User` model and a `sendEmail` function, then call:  
   ```js
   const { router, protect } = initAuth(config, sendEmail, User);
   app.use("/auth", router);
   ```

3. Optionally scaffold files in your project using the CLI:  
   ```bash
   npx mern-access init
   # or
   npx mern-access init --with-nodemailer
   ```

---

## ‚ú® Features

- Signup with email, username, and password (with OTP verification).  
- Login with short‚Äëlived access tokens + long‚Äëlived refresh tokens.  
- Refresh endpoint with token reuse detection (revokes sessions on suspicious use).  
- Logout (all sessions).  
- `protect` middleware to secure custom routes.  
- Custom `mapUserData(user)` function to shape returned user data.  
- CLI initializer: `npx mern-access init` to scaffold config, model, and sample usage file.

---

## üì¶ Requirements

- Node.js >= 16  
- MongoDB (Atlas or local)  
- **Mongoose** installed in your project  
- You must connect Mongoose (`mongoose.connect(...)`) before calling `initAuth`  
- Provide a **Mongoose `User` model** and a `sendEmail({to, subject, html})` function  

---

## üõ† Installation

```bash
npm install mern-access
# or
yarn add mern-access
```

---

## üìÇ Project Structure (example)

```
project-root/
‚îú‚îÄ‚îÄ auth.config.js        # generated by CLI or created manually
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ User.js           # Mongoose User model used by mern-access
‚îú‚îÄ‚îÄ .usage.sample.js      # scaffolded usage example (instead of routes/)
‚îú‚îÄ‚îÄ index.js              # your server entry point
‚îî‚îÄ‚îÄ .env                  # environment variables
```

---

## üë§ User Schema (required fields)

These fields are **mandatory** ‚Äî renaming them will break the package.

```js
const refreshTokenSchema = new mongoose.Schema({
  tokenHash: { type: String, index: true },
  userAgent: String,
  ip: String,
  createdAt: { type: Date, default: Date.now },
  expiresAt: { type: Date, index: true }
}, { _id: false });

const UserSchema = new mongoose.Schema({
  email: { type: String, unique: true, required: true },
  username: { type: String, unique: true, required: true },
  password: { type: String, required: true },
  verified: { type: Boolean, default: false },
  otp: String,
  otpExpiry: Date,
  refreshTokens: { type: [refreshTokenSchema], default: [] }
}, { timestamps: true });

module.exports = mongoose.models.User || mongoose.model("User", UserSchema);
```

---

## ‚öôÔ∏è Config (`auth.config.js`)

`initAuth(config, sendEmail, User)` reads configuration for JWT, emails, and user mapping.

```js
module.exports = {
  jwt: {
    accessSecret: process.env.ACCESS_SECRET,    // REQUIRED
    refreshSecret: process.env.REFRESH_SECRET,  // REQUIRED
    accessExpiry: "15m",
    refreshExpiry: "7d"
  },
  email: {
    subject: "Verify your account",
    body: ({ username, otp }) => `<p>Hello ${username}, your code is <b>${otp}</b></p>`
  },
  mapUserData: (user) => ({
    id: user._id,
    email: user.email,
    username: user.username,
    verified: user.verified
  })
};
```

---

## üîå Usage

Example `index.js`:

```js
const express = require("express");
const cors = require("cors");
const mongoose = require("mongoose");
require("dotenv").config();

const { initAuth } = require("mern-access");
const User = require("./models/User");
const config = require("./auth.config");

async function sendEmail({ to, subject, html }) {
  console.log("EMAIL SENT:", to, subject);
}

(async () => {
  await mongoose.connect(process.env.MONGO_URI);
  const app = express();
  app.use(express.json());
  app.use(cors({ origin: true, credentials: true }));

  const { router, protect } = initAuth(config, sendEmail, User);
  app.use("/auth", router);

  app.get("/me", protect, (req, res) => {
    res.json({ user: req.user });
  });

  app.listen(process.env.PORT || 4001);
})();
```

---

## üì° Endpoints (mounted at `/auth`)

| Endpoint            | Method | Description |
|---------------------|--------|-------------|
| `/auth/signup`      | POST   | Register new user & send OTP |
| `/auth/verify`      | POST   | Verify OTP or resend code |
| `/auth/login`       | POST   | Login with email/username + password |
| `/auth/refresh`     | POST   | Refresh access token |
| `/auth/logout-everywhere`  | POST   | Logout from all devices |

---

## üõ† curl Examples

Signup:
```bash
curl -X POST http://localhost:4001/auth/signup -H "Content-Type: application/json" -d '{"email":"alice@example.com","username":"alice","password":"Secret123"}'
```

Verify:
```bash
curl -X POST http://localhost:4001/auth/verify -H "Content-Type: application/json" -d '{"email":"alice@example.com","otp":"123456"}'
```

Login:
```bash
curl -X POST http://localhost:4001/auth/login -H "Content-Type: application/json" -d '{"identifier":"alice","password":"Secret123"}'
```

---

## üõ° Security Best Practices

- Store secrets (`ACCESS_SECRET`, `REFRESH_SECRET`) in environment variables.  
- Use **HTTPS** in production.  
- Never store refresh tokens in localStorage.  
- Avoid logging OTPs in production.  
- Rotate secrets periodically.  

---

## üß∞ CLI Scaffolding

Run from your project root:

```bash
npx mern-access init
# or
npx mern-access init --with-nodemailer
```

Creates:
- `auth.config.js`
- `models/User.js`
- `.usage.sample.js`
- (with `--with-nodemailer`) `.env.sample` + auto‚Äëinstall of `nodemailer`

---

## ‚ö†Ô∏è Troubleshooting

- **OverwriteModelError**: use  
  ```js
  module.exports = mongoose.models.User || mongoose.model("User", UserSchema);
  ```
- **Missing secrets**: set `ACCESS_SECRET` and `REFRESH_SECRET` in env.  

---

## üìú License

MIT ¬© 2025
